---
title: 'Orientation: L2'
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

<!--
Subject -> Subject
Type -> Type
Trial -> Trial
LeaYrs + 
Post <- Post
Pre + 
AECI <- ML2 
DUH
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev='jpeg')
options(formatR.arrow=TRUE, width=100, digits=5,show.signif.stars = TRUE)
library(ggplot2)
library(dplyr)
library(lme4)
#library(lmerTest)
#library(lmtest)
library(stringr)
#library(merTools)
library(latticeExtra)
```

## Data analysis


We load the data and remove the cases with NA values.
```{r data, echo=FALSE}
load("orientation.RData")
DLM<-Orientation
num<-DLM %>% group_by(List) %>% summarize(n_distinct(Subject))
```

We have `r nlevels(DLM$Subject)` subjects for a total of `r dim(DLM)[1]` observations.  The subjects are distributed between the lists as follows: 


```{r echo=FALSE, results=TRUE}
print(num)
```


```{r naomit, echo=FALSE}
DLM<-na.omit(DLM)
DLM$Subject<-factor(DLM$Subject)
num<-DLM %>% group_by(List) %>% summarize(n_distinct(Subject))
```
After removal of entries with missing data due to wrong answers, we have `r nlevels(DLM$Subject)` subjects and `r dim(DLM)[1]` observations left.  The subjects are distributed between the lists as follows: 


```{r echo=FALSE, results=TRUE}
print(num)
```

```{r dataoverview, eval=FALSE, echo=FALSE}
# Let's have a glimpse at the data:
# tbl_df(DLM)
glimpse(DLM)
```



<!--We removed the subjects that had `Post` or `Post2` smaller than 75%. -->

We consider the following independent variables:

1. `LeaYrs` a numerical variable with values ranging from 1 to 16. Learning in years.

2. `Pre` a percentage scaled to lay between 0 and 10. It indicates the previous knowledge.
3. `Post` a percentage scaled to lay between 0 and 10. It indicates the post test proficency. 
<!--- `RPV`  a numerical variable with values ranging from 1 to 4.5.-->
<!--- `AMGE`  a numerical variable with values ranging from 1 to 5.-->

4. `AECI`  a numerical variable with values ranging from 1 to 5.

5. `DUH`  a numerical variable with values ranging from 0 to 11.5. L2 use in hours per day.

We rescaled some of these variables to be on similar scales. We treat these as fixed factors under study. In addition we have the random factors given by trials and subjects nested within the lists. A nesting of the trial within the type seemed not necessary.

Our base model is the following:
`lmm <- lmer(log(Time) ~ Type + LeaYrs + Pre + Post + AECI + DUH + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM)`

```{r basicmodel}
lmm <- lmer(log(Time) ~  Type + LeaYrs + Pre + Post + AECI + DUH + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM, REML=FALSE)
#summary(lmm)
```


We check whether the random effects are important to be included using the corrected AIC criterion:


```{r randomeffectslrt, warning=TRUE}
lmm.0 <- lm(log(Time) ~  Type + LeaYrs + Pre + Post + AECI + DUH, data = DLM)
lmm.1 <- lmer(log(Time) ~ Type + LeaYrs + Pre + Post + AECI + DUH + (1 | List:Subject), data = DLM, REML=FALSE)
lmm.2 <- lmer(log(Time) ~ Type + LeaYrs + Pre + Post + AECI + DUH + (1 | List:Type:Trial), data = DLM, REML=FALSE)
AIC(lmm.0,lmm.1,lmm.2)

lmm.4 <- update(lmm,.~.-(1 | List:Subject))
anova(lmm.4,lmm)

lmm.5 <- update(lmm,.~.-(1 | List:Type:Trial))
anova(lmm.5,lmm)
```



We then consider which fixed effects to include in the model.

## Heuristic Search

We use a  manual, step-forward procedure with likelihood ratio test to prepare an initial model for exhaustive search.


```{r mixedmodels2, warning=TRUE}
lmm.0 <- lmer(log(Time) ~  (1 | List:Subject) + (1 | List:Type:Trial), data = DLM)

lmm.1 <- update(lmm.0, .~. + Type)
anova(lmm.0,lmm.1)

lmm.2 <- update(lmm.0, .~.+LeaYrs)
anova(lmm.0,lmm.2)

lmm.3 <- update(lmm.0, .~. + Post) 
anova(lmm.0,lmm.3)

lmm.3 <- update(lmm.0, .~. + Pre) 
anova(lmm.0,lmm.3)

lmm.3 <- update(lmm.0, .~. + Post) 
anova(lmm.0,lmm.3)

lmm.4 <- update(lmm.0, .~. + AECI)
anova(lmm.0,lmm.4)

lmm.5 <- update(lmm.0, .~. + DUH)
anova(lmm.0,lmm.5)

lmm.3 <- update(lmm.0, .~. + Pre*Post) 
anova(lmm.0,lmm.3)
```

Further, we use an automatic, step-backward procedure from the package
lmerTest starting from a model that includes all second order fixed
factor intereactions to understand which second order interactions are likely to be relevant.

```{r mixedmodels4, echo=TRUE, eval=TRUE, warning=FALSE}
lmm.6 <- lmer(log(Time) ~ (Type + List + LeaYrs + Post + Pre + AECI + DUH)^2 + (1|List) + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM, na.action="na.fail",REML=FALSE)

require(lmerTest)
ft<-step(lmm.6, lsmeans.calc = TRUE)
ft
#summary(ft$model)
#lmm<-ft$model
```

Looking at the output produced above we see which second order terms had more chances to be included in the model. We include as many of those second order terms as we can while keeping an exhaustive search feasible. 


## Exhaustive search

Using the insight from the previous analysis we construct an initial model to search exhaustively.

```{r dredge, echo=TRUE, eval=TRUE, warning=FALSE}
lmm.6<-lmer(log(Time) ~ Type + List + LeaYrs + Post + Pre + AECI + DUH + (1 | List:Subject) + (1 | List:Type:Trial) +
           Type:List + Pre:Post + List:LeaYrs + Pre:AECI + Type:DUH,
          data=DLM, na.action="na.fail", REML=FALSE)

library(MuMIn)
dredge.res<-dredge(lmm.6, beta = c("none"), evaluate = TRUE, rank = "AICc", fixed = NULL, m.lim = NULL,  trace = FALSE)
#print(dredge.res)
attr(dredge.res, "model.calls")[1]
```


The final model on which we base our exhaustive search is:

```{r fitmodel, echo=TRUE}
lmm <- lmer(formula = log(Time) ~ AECI + LeaYrs + List + Post + Pre + 
    Type + (1 | List:Subject) + (1 | List:Type:Trial) + AECI:Pre + 
    LeaYrs:List + List:Type + Post:Pre, data = DLM, REML = FALSE)
```

See below, in the Anova section, the summary of this model.



## Diagnostic plots

```{r plotlmr, fig.height=8}

par(mfrow=c(2,2))
# plot(lm4,which=1:4)

plot(fitted(lmm, Type = "response"), residuals(lmm, Type = "response"),
     main = "Conditional residuals", xlab = "Predicted", ylab = "Residuals")

res <- residuals(lmm, Type = "response")
qqnorm(res, main = "Conditional residuals, QQplot")
qqline(res)

lmm.0 <- lm(formula = log(Time) ~ AECI + LeaYrs + List + Post + Pre + Type + AECI:Pre + 
    LeaYrs:List + List:Type + Post:Pre, data = DLM)
#lm.0 <- update(lmm,.~.-(1 | List:Subject) - (1 | List:Type:Trial))
x <- model.matrix(lmm.0)
pred <- x %*% fixef(lmm)
res <- DLM$Time - pred
plot(pred, res, main = "Marginal residuals", xlab = "Predicted", ylab = "Residuals")
qqnorm(res, main = "Marginal residuals, QQplot")
qqline(res)

```


```{r plot1, fig.width=3, echo=FALSE, eval=FALSE}
plot(lmm,Type=c("p","smooth"))
plot(lmm,sqrt(abs(resid(.))) ~ fitted(.), Type=c("p","smooth"))
qqmath(lmm,id=0.005)
# package HLMdiag influence.ME
```


The joint qqplot looks normal. The marginal looks less nice. 



## p-values

Anova of type III with Satterwhite Approximation:

```{r anova}
require(lmerTest)
anova(lmm)
summary(lmm)
```

Bootstrap confidence intervals: 

```{r confintstd, eval=FALSE, echo=FALSE}
# confint(lmm,method="Wald")
confint(lmm,method="boot")
```


## Conclusions




The figures below show random and the fixed effects. The random effects show that the different subjects imply a significantly different intercept. In the plot of the fixed effects, we back transformed the effects in linear scale and added 0.95-confidence level bands. 


```{r randomeff, height=4, width=6, echo=FALSE}
#plotREsim(REsim(lmm, n.sims = 100), stat = 'median', sd = TRUE)
source("lib.R")
randeff.plot2(lmm)
```

For the fixed effects we plot all plots relative to statistically significant terms. 
The instructive plots are the main effect of `LeaYrs` and the interaction between `Post` and `Pre`, which, we deem, explains the significance of the `Post` term as well.

* The reaction time decreases as learning years increase. 

* For low values of `Pre` an increase of `Post` reduces reaction times. The reduction fades away as `Pre` increases. 




```{r fixedeff, height=4, width=6, echo=FALSE}
#require(merTools)
#plotFEsim(FEsim(lmm, n.sims = 100), level = 0.9, stat = 'median', intercept = FALSE)
require(effects)

plot(effects::Effect(c("AECI"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="",
     bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black")) 

plot(effects::Effect(c("LeaYrs"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="",
     bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black")) 

plot(effects::Effect(c("List"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="",
     bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"))

plot(effects::Effect(c("Post"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",xlab="Post",main="", 
     bg="grey50",fg="black", alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"))

#
plot(effects::Effect(c("LeaYrs","List"), lmm, x.var="List", transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"),layout=c(2,1)) 

plot(effects::Effect(c("List","Type"), lmm, x.var="List", transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"),layout=c(2,1)) 

plot(effects::Effect(c("Pre","Post"), lmm, xlevels=list(Pre=4), x.var="Post", transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"),layout=c(4,1)) 

hist(DLM$Pre)
```

The last plot shows the histogram of entries with respect to the `Pre` value. The number of data point with low `Pre` values is however low, which is reflected in the much wider confidence bands of the preceeding plots. 


Plot of the coefficient estimates of one variable conditional on the values of the other variable in the interaction term.

```{r interplot, height=4, width=6, echo=FALSE}
library(interplot)
interplot(m = lmm, var1 = "Post", var2 = "Pre",hist=TRUE)+xlab("Pre")+ylab("Post")
```

