---
title: 'Size: L2'
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,dev='jpeg')
options(formatR.arrow=TRUE, width=120, digits=5,show.signif.stars = TRUE)
library(ggplot2)
library(party)
library(dplyr)
library(lme4)
#library(lmerTest)
#library(lmtest)
library(stringr)
#library(merTools)
library(latticeExtra)
library(xtable)
library(interplot)
```


## Data analysis

We load the data and remove the cases with NA values.
```{r data, echo=FALSE}
load("size.RData")
DLM<-Size
num<-DLM %>% group_by(List) %>% summarize(n_distinct(Subject))
```

We have `r nlevels(DLM$Subject)` subjects for a total of `r dim(DLM)[1]` observations.  The subjects are distributed between the lists as follows: 


```{r echo=FALSE, results=TRUE}
print(num)
```

```{r naomit, echo=FALSE}
DLM<-na.omit(DLM)
DLM$Subject<-factor(DLM$Subject)
num<-DLM %>% group_by(List) %>% summarize(n_distinct(Subject))
```
After removal of entries with missing data due to wrong answers, we have `r nlevels(DLM$Subject)` subjects and `r dim(DLM)[1]` observations left.  The subjects are distributed between the lists as follows: 


```{r echo=FALSE, results=TRUE}
print(num)
```

```{r dataoverview, eval=FALSE, echo=FALSE}
# Let's have a glimpse at the data:
# tbl_df(DLM)
glimpse(DLM)
```

We consider the following independent variables:

1. `LeaYrs` a numerical variable with values ranging from 1 to 16. Learning in years.
2. `Pre` a percentage scaled to lay between 0 and 10. It indicates the previous knowledge.
3. `Post` a percentage scaled to lay between 0 and 10. It indicates the post test proficency. 

<!--- `RPV`  a numerical variable with values ranging from 1 to 4.5.-->
<!--- `AMGE`  a numerical variable with values ranging from 1 to 5.-->
4. `AECI`  a numerical variable with values ranging from 1 to 5.
5. `DUH`  a numerical variable with values ranging from 0 to 11.5. L2 use in hours per day.

We rescaled some of these variables to be on similar scales. We treat these as fixed factors under study. In addition we have the random factors described earlier. The same modelling set up applies here.

Our basic model is: 
`lmm <- lmer(log(Time) ~ Type + LeaYrs + Pre + Post + AECI + DUH +  (1 | List:Subject) + (1 | List:Type:Trial), data = DLM)`

```{r basicmodel}
lmm <- lmer(log(Time) ~  Type + LeaYrs + Pre + Post + AECI + DUH  + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM, REML=FALSE)
#summary(lmm)
```


We check whether the random effects are important to be included using the corrected AIC criterion:


```{r randomeffectslrt, warning=TRUE}
lmm.0 <- lm(log(Time) ~  Type + LeaYrs + Pre + Post + AECI + DUH, data = DLM)
lmm.1 <- lmer(log(Time) ~ Type + LeaYrs + Pre + Post + AECI + DUH + (1 | List:Subject), data = DLM, REML=FALSE)
lmm.2 <- lmer(log(Time) ~ Type + LeaYrs + Pre + Post + AECI + DUH + (1 | List:Type:Trial), data = DLM, REML=FALSE)
AIC(lmm.0,lmm.1,lmm.2)

lmm.4 <- update(lmm,.~.-(1 | List:Subject))
anova(lmm.4,lmm)

lmm.5 <- update(lmm,.~.-(1 | List:Type:Trial))
anova(lmm.5,lmm)
```

We then consider which fixed effects to include in the model.

## Heuristic Search

We use a  manual, step-forward procedure with likelihood ratio test to prepare an initial model for exhaustive search.

```{r mixedmodels3, warning=TRUE}
lmm.0 <- lmer(log(Time) ~  (1 | List:Subject) + (1 | List:Type:Trial), data = DLM)

lmm.1 <- update(lmm.0, .~. + Type)
anova(lmm.0,lmm.1)

lmm.2 <- update(lmm.0, .~.+LeaYrs)
anova(lmm.0,lmm.2)

lmm.3 <- update(lmm.0, .~. + Post) 
anova(lmm.0,lmm.3)

lmm.3 <- update(lmm.0, .~. + Pre) 
anova(lmm.0,lmm.3)

lmm.3 <- update(lmm.0, .~. + Post) 
anova(lmm.0,lmm.3)

lmm.4 <- update(lmm.0, .~. + AECI)
anova(lmm.0,lmm.4)

lmm.5 <- update(lmm.0, .~. + DUH)
anova(lmm.0,lmm.5)

lmm.3 <- update(lmm.0, .~. + Pre*Post) 
anova(lmm.0,lmm.3)
```


Further, we use an automatic, step-backward procedure from the package
lmerTest starting from a model that includes all second order fixed
factor intereactions to understand which second order interactions are likely to be relevant. Including all second order interactions in an exhaustive search turned out to be computationally too demanding.


```{r mixedmodels4, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
require(lmerTest)
lmm.6 <- lmer(log(Time) ~ (Type + LeaYrs + Post + Pre + AECI + DUH)^2 + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM)
ft<-step(lmm.6)
ft
#summary(ft$model)
#lmm<-ft$model
```


## Exhaustive search

```{r dredge, echo=TRUE, eval=TRUE, warning=FALSE}
lmm.6<-lmer(log(Time) ~ Type + List + LeaYrs + Post + Pre + AECI + DUH + (1 | List:Subject) + (1 | List:Type:Trial) +
           Type:Post + Type:Pre +Pre:Post + Pre:AECI +LeaYrs:DUH + LeaYrs:Pre,
          data=DLM, na.action="na.fail", REML=FALSE)

library(MuMIn)
dredge.res<-dredge(lmm.6, beta = c("none"), evaluate = TRUE, rank = "AICc", fixed = NULL, m.lim = NULL,  trace = FALSE)
print(dredge.res[1:5,])
print(xtable(dredge.res[1:5,]),type="html")
attr(dredge.res, "model.calls")[1]
```



The final model on which we base our exhaustive search is:

```{r fitmodel, echo=TRUE}
lmm <- lmer(formula = log(Time) ~ AECI + Post + Pre + Type + (1 | 
    List:Subject) + (1 | List:Type:Trial) + AECI:Pre + Post:Pre + 
    Post:Type + Pre:Type, data = DLM, REML = FALSE, na.action = "na.fail")
```

See below, in the Anova section, the summary of this model.
Note that the main effects `LeaYrs` and `List` have not been included.



## Diagnostic plots

```{r plotlmr, fig.height=8}

par(mfrow=c(3,2))
# plot(lm4,which=1:4)

plot(fitted(lmm, Type = "response"), residuals(lmm, Type = "response"),
     main = "Conditional residuals", xlab = "Predicted", ylab = "Residuals")

res <- residuals(lmm, Type = "response")
qqnorm(res, main = "Conditional residuals, QQplot")
qqline(res)

lmm.0 <- lm(formula = log(Time) ~ AECI + Post + Pre + Type + AECI:Pre + Post:Pre + 
      Post:Type + Pre:Type,data=DLM) 
x <- model.matrix(lmm.0)
pred <- x %*% fixef(lmm)
res <- DLM$Time - pred
plot(pred, res, main = "Marginal residuals", xlab = "Predicted", ylab = "Residuals")
qqnorm(res, main = "Marginal residuals, QQplot")
qqline(res)

```

```{r plot1, fig.width=3, echo=FALSE, eval=FALSE}
plot(lmm,Type=c("p","smooth"))
plot(lmm,sqrt(abs(resid(.))) ~ fitted(.), Type=c("p","smooth"))
qqmath(lmm,id=0.005)
# package HLMdiag influence.ME
```


The joint qqplot looks normal. The marginal looks less nice. 






## p-values

Anova of type III with Satterwhite Approximation

```{r anova}
require(lmerTest)
anova(lmm)
summary(lmm)
```

Bootstrap confidence intervals

```{r confintstd, eval=TRUE, echo=TRUE}
#confint(lmm,method="Wald")
confint(lmm,method="boot")
```


## Conclusions

All analyses indicate  that  only `Post` and its interaction with `Pre` are significant effects. 



The figures show random  and the fixed effects. Again the subject effects are significant. We back transformed the fixed effects in linear scale and added 0.95-confidence level bands. It is evident the reduction in reaction time as `AECI` increases. The `DUH` values do not seem to have a considerable impact while `Pre` and `Post` interactions are relevant but only among subjects with low `Post`. Finally, `DUH` and `Post` interactions are depicted.

```{r randomeff, height=4, width=6, echo=FALSE}
#plotREsim(REsim(lmm, n.sims = 100), stat = 'median', sd = TRUE)
source("lib.R")
randeff.plot2(lmm)
```

```{r fixedeff, height=4, width=6, echo=FALSE}
require(effects)


plot(effects::Effect(c("AECI"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="",
     bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black")) 

plot(effects::Effect(c("Post"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",xlab="Post",main="", 
     bg="grey50",fg="black", alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"))

plot(effects::Effect(c("Pre"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="",
     bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"))

plot(effects::Effect(c("Type"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="",
     bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"))

#
plot(effects::Effect(c("AECI","Pre"), lmm,  xlevels=list(Pre=4), x.var="AECI", transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"),layout=c(4,1)) 

plot(effects::Effect(c("Post","Type"), lmm, x.var="Post", transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"),layout=c(2,1)) 

plot(effects::Effect(c("Pre","Type"), lmm, x.var="Pre", transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"),layout=c(2,1)) 

plot(effects::Effect(c("Pre","Post"), lmm, xlevels=list(Pre=4), x.var="Post", transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",alternating=FALSE,
     par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"),layout=c(4,1)) 


hist(DLM$Pre)
```

The last plot shows the histogram of entries with respect to the `Pre` value. The number of data point with low `Pre` values is however low, which is reflected in the much wider confidence bands of the preceeding plots. 





Plot of the coefficient estimates of one variable conditional on the values of the other variable in the interaction term.

```{r interplot, height=4, width=6, echo=FALSE}
interplot(m = lmm, var1 = "Post", var2 = "Pre",hist=TRUE)+xlab("Pre")+ylab("Post")
```


