---
title: 'Size: L2'
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,dev='jpeg')
options(formatR.arrow=TRUE, width=100, digits=5,show.signif.stars = TRUE)
library(ggplot2)
library(party)
library(dplyr)
library(lme4)
#library(lmerTest)
#library(lmtest)
library(stringr)
#library(merTools)
library(latticeExtra)
```


## Data analysis

We load the data and remove the cases with NA values.
```{r data, echo=FALSE}
load("size.RData")
DLM<-Size
num<-DLM %>% group_by(List) %>% summarize(n_distinct(Subject))
```

We have `r nlevels(DLM$Subject)` subjects for a total of `r dim(DLM)[1]` observations.  The subjects are distributed between the lists as follows: 


```{r echo=FALSE, results=TRUE}
print(num)
```

```{r naomit, echo=FALSE}
DLM<-na.omit(DLM)
DLM$Subject<-factor(DLM$Subject)
num<-DLM %>% group_by(List) %>% summarize(n_distinct(Subject))
```
After removal of entries with missing data due to wrong answers, we have `r nlevels(DLM$Subject)` subjects and `r dim(DLM)[1]` observations left.  The subjects are distributed between the lists as follows: 


```{r echo=FALSE, results=TRUE}
print(num)
```

```{r dataoverview, eval=FALSE, echo=FALSE}
# Let's have a glimpse at the data:
# tbl_df(DLM)
glimpse(DLM)
```

We consider the following independent variables:

1. `LeaYrs` a numerical variable with values ranging from 1 to 16. Learning in years.
2. `Post` a percentage scaled to lay between 0 and 10. It indicates the post test proficency. 
3. `Pre` a percentage scaled to lay between 0 and 10. It indicates the previous knowledge.
<!--- `RPV`  a numerical variable with values ranging from 1 to 4.5.-->
<!--- `AMGE`  a numerical variable with values ranging from 1 to 5.-->
4. `AECI`  a numerical variable with values ranging from 1 to 5.
5. `DUH`  a numerical variable with values ranging from 0 to 11.5. L2 use in hours per day.

We rescaled some of these variables to be on similar scales. We treat these as fixed factors under study. In addition we have the random factors described earlier. The same modelling set up applies here.

The basic model is: 
`lmm <- lmer(log(Time) ~ Type + LeaYrs + (Pre + Post)^2 + AECI + DUH + Post*DUH +  (1 | List:Subject) + (1 | List:Type:Trial), data = DLM)`

```{r basicmodel}
lmm <- lmer(log(Time) ~  Type + LeaYrs + (Pre + Post)^2 + AECI + DUH + Post*DUH + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM, REML=FALSE)
#summary(lmm)
```

We use a  manual, step-forward procedure with likelihood ratio test to see which of the fixed effects are significant.


```{r mixedmodels2, warning=TRUE}
lmm.0 <- lmer(log(Time) ~  (1 | List:Subject) + (1 | List:Type:Trial), data = DLM)

lmm.1 <- update(lmm.0, .~. + Type)
anova(lmm.0,lmm.1)

lmm.2 <- update(lmm.0, .~.+LeaYrs)
anova(lmm.0,lmm.2)

lmm.3 <- update(lmm.0, .~. + Post) 
anova(lmm.0,lmm.3)

lmm.3 <- update(lmm.0, .~. + Pre) 
anova(lmm.0,lmm.3)

lmm.3 <- update(lmm.0, .~. + Post) 
anova(lmm.0,lmm.3)

lmm.3 <- update(lmm.0, .~. + Pre*Post) 
anova(lmm.0,lmm.3)

lmm.4 <- update(lmm.0, .~. + AECI)
anova(lmm.0,lmm.4)

lmm.5 <- update(lmm.0, .~. + DUH)
anova(lmm.0,lmm.5)
```

We conclude that only `AECI` has a significant effect at a 0.05 level while the Type has a significant effect at a level of 0.1.


An automatic, step-backward procedure from the package lmerTest starting from a model that includes all second order fixed factor intereactions lead to a different conclusion: the factors AECI, Post, DUH and the interaction between these last two are significant.


```{r mixedmodels4, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
require(lmerTest)
lmm.6 <- lmer(log(Time) ~ (Type + LeaYrs + Post + Pre + AECI + DUH)^2 + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM)
ft<-step(lmm.6)
ft
summary(ft$model)
lmm<-ft$model
```


## Exhaustive search

```{r dredge, echo=TRUE, eval=TRUE, warning=FALSE}
lmm.6 <- lmer(log(Time) ~ (Type + List + LeaYrs + Post + Pre + AECI + DUH)+AECI*DUH+Post*Pre + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM, na.action="na.fail",REML=FALSE)

library(MuMIn)
dredge.res<-dredge(lmm.6, beta = c("none"), evaluate = TRUE, rank = "AICc", fixed = NULL, m.lim = NULL,  trace = FALSE)
print(dredge.res)
attr(dredge.res, "model.calls")[1]
```



Finally, Analysis of Variance Table of Type III  with  Satterthwaite 
approximation for degrees of freedom gives produces yet another different analysis. It is reported at the end of this document.


All three analysis indicate however that  `AECI`  is significant. 


```{r confintstd, eval=FALSE, echo=FALSE}
confint(lmm,method="Wald")
confint(lmm,method="boot")
```


The figures show random  and the fixed effects. Again the subject effects are significant. We back transformed the fixed effects in linear scale and added 0.95-confidence level bands. It is evident the reduction in reaction time as `AECI` increases. The `DUH` values do not seem to have a considerable impact while `Pre` and `Post` interactions are relevant but only among subjects with low `Post`. Finally, `DUH` and `Post` interactions are depicted.

```{r randomeff, height=4, width=6, echo=FALSE}
#plotREsim(REsim(lmm, n.sims = 100), stat = 'median', sd = TRUE)
source("lib.R")
randeff.plot2(lmm)
```

```{r fixedeff, height=4, width=6, echo=FALSE}
require(effects)
plot(effects::Effect(c("Post"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",
     alternating=FALSE,par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black")) 

plot(effects::Effect(c("AECI"), lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",xlab="Motivation",main="", bg="grey50",fg="black",
     alternating=FALSE,par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black")) 

plot(effects::Effect(c("DUH"), lmm, transformation=list(link=log,inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="",xlab="Use", bg="grey50",fg="black",
     alternating=FALSE,par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black")) 
#plot(effects::Effect(c("Pre","Post"), lmm, transformation=list(link=log, inverse=exp)),cex=1,width=0,lwd=1,ylab="milliseconds",main="", bg="grey50",fg="black",alternating=FALSE,par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black")) 

plot(effects::Effect(c("DUH","Post"),x.var="DUH", lmm, transformation=list(link=log, inverse=exp)),
     cex=1,width=0,lwd=1,ylab="Reaction Time (ms)",main="", bg="grey50",fg="black",
     alternating=FALSE,par.settings = ggplot2like(),lines.title=0,between=list(x=1),colors=c("grey35","black"),layout=c(4,1))
#require(merTools)
#plotFEsim(FEsim(lmm, n.sims = 100), level = 0.9, stat = 'median', intercept = FALSE)

hist(DLM$Pre)

library(interplot)
interplot(m = lmm, var1 = "DUH", var2 = "Post",hist=TRUE)+xlab("Post")+ylab("DUH")

```



## Diagnostic plots

```{r plotlmr, fig.height=8}

par(mfrow=c(3,2))
# plot(lm4,which=1:4)

plot(fitted(lmm, Type = "response"), residuals(lmm, Type = "response"),
     main = "Conditional residuals", xlab = "Predicted", ylab = "Residuals")

res <- residuals(lmm, Type = "response")
qqnorm(res, main = "Conditional residuals, QQplot")
qqline(res)

#lm.0 <- lm(log(Time) ~ (Type + LeaYrs + (Pre + Post)^2 + AECI + DUH + Post*DUH ), data = DLM)
lm.0 <- lm(log(Time) ~ (Post + AECI + DUH + Post*DUH ), data = DLM)
x <- model.matrix(lm.0)
pred <- x %*% fixef(lmm)
res <- DLM$Time - pred
plot(pred, res, main = "Marginal residuals", xlab = "Predicted", ylab = "Residuals")
qqnorm(res, main = "Marginal residuals, QQplot")
qqline(res)

```

```{r plot1, fig.width=3, echo=FALSE, eval=FALSE}
plot(lmm,Type=c("p","smooth"))
plot(lmm,sqrt(abs(resid(.))) ~ fitted(.), Type=c("p","smooth"))
qqmath(lmm,id=0.005)
# package HLMdiag influence.ME
```


The joint qqplot looks normal. The marginal looks less nice. 


## Anova Table with Satterwhite 

```{r anova}
require(lmerTest)
lmm <- lmer(log(Time) ~  Type + LeaYrs + (Pre + Post)^2 + AECI + DUH + Post*DUH + (1 | List:Subject) + (1 | List:Type:Trial), data = DLM, REML=FALSE)
anova(lmm)
summary(lmm)
```
